function load(){var e=$("#map").data("default-map-center");window.centerLatLng=new google.maps.LatLng(e.lat,e.lng),gmap=new google.maps.Map($("#map")[0],{zoom:8,center:centerLatLng,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.ROADMAP]},scaleControl:!0,scaleControlOptions:{position:google.maps.ScaleControlStyle.RIGHT}});var n=!1;""==$("#geofence_latitude").val()?(n=!1,gmap.setCenter(new google.maps.LatLng(e.lat,e.lng)),gmap.setZoom(zoom)):(n=!0,centerMap()),installFenceEditingListeners(),n&&(drawGeofence(),window.centerMarker!=undefined&&window.centerMarker.setMap(null),window.centerMarker=new google.maps.Marker({position:new google.maps.LatLng(circle_center[0],circle_center[1]),map:gmap,icon:orangeSmallIcon}))}function polygonArea(e){var n=0,o=0,a=0,r=e.length,t=[],l=[];for(o=0;o<r;o++){var i=e.getAt(o);t.push(i.lat()),l.push(i.lng())}for(o=0;o<r;o++)a++,a==r&&(a=0),n+=(t[o]+t[a])*(l[o]-l[a]);return n*=.5,n<0&&(n*=-1),4761*n*.77225511}function installFenceEditingListeners(){google.maps.event.clearListeners(gmap,"click"),$("#geofence_shape_type_1").is(":checked")?google.maps.event.addDomListener(gmap,"click",function(e){polygonal_drawing_open=!0,polypoints_array.push([e.latLng.lat(),e.latLng.lng()]),drawGeofence()}):google.maps.event.addDomListener(gmap,"click",function(e){circle_center=[e.latLng.lat(),e.latLng.lng()],$("#geofence_latitude").val(circle_center[0]),$("#geofence_longitude").val(circle_center[1]),$("#geofence_address").val(circle_center.join(",")),address_modified=!1,drawGeofence(),centerMap()})}function clearPoints(){polygonal_drawing_open=!0,$("#geofence_polypoint_string").val(""),polypoints_array=[],window.geofenceOverlay!=undefined&&window.geofenceOverlay.setMap(null),window.geofenceMarker!=undefined&&window.geofenceMarker.setMap(null)}function closeShape(){$("#geofence_polypoint_string").val($.map(polypoints_array,function(e){return"["+e.join(",")+"]"}).join(":")),polygonal_drawing_open=!1,polypoints_array.push(polypoints_array[0]),drawGeofence()}function geocode(e,n){return $("#geofence_latitude").val(""),$("#geofence_longitude").val(""),""==e?(alert("You must enter an address or Latitude, Longitude."),!1):e.match(/^\s*[0-9\.\-]+,\s*[0-9\.\-]+\s*/)?(address_modified=!1,window.geocode_button_needs_clicking=!1,circle_center=e.split(",").map(function(e){return e.replace(/\s/g,"")}),$("#geofence_latitude").val(circle_center[0]),$("#geofence_longitude").val(circle_center[1]),centerMap(),drawGeofence(),window.centerMarker!=undefined&&window.centerMarker.setMap(null),window.centerMarker=new google.maps.Marker({position:new google.maps.LatLng(circle_center[0],circle_center[1]),map:gmap,icon:orangeSmallIcon}),n&&$("#geofence_form").submit(),!0):void(new google.maps.Geocoder).geocode({address:e},function(o,a){window.geocoderResults=o,window.geocoderStatus=a,"ZERO_RESULTS"==a||"OK"!=a||0==o.length?(alert('"'+e+'" not found.'),window.geocode_button_needs_clicking=!0):(window.results=o,window.results.length>1?(window.geocode_button_needs_clicking=!0,alert("Too many matching addresses were found.  Please be more specific.")):(address_modified=!1,window.geocode_button_needs_clicking=!1,circle_center=[window.results[0].geometry.location.lat(),window.results[0].geometry.location.lng()],$("#geofence_latitude").val(circle_center[0]),$("#geofence_longitude").val(circle_center[1]),window.centerMarker!=undefined&&window.centerMarker.setMap(null),window.centerMarker=new google.maps.Marker({position:new google.maps.LatLng(circle_center[0],circle_center[1]),map:gmap,icon:orangeSmallIcon}),centerMap(),drawGeofence(),n&&$("#geofence_form").submit()))})}function setZoomFromRadius(){var e=$("#geofence_radius").val();return parseInt(e)>25?3:parseInt(e)>5?7:parseInt(e)>=1?10:15}function centerMap(){""!=$("#geofence_latitude").val()&&""!=$("#geofence_longitude").val()&&(circle_center=[1*$("#geofence_latitude").val(),1*$("#geofence_longitude").val()],gmap.setCenter(new google.maps.LatLng(circle_center[0],circle_center[1])),gmap.setZoom(setZoomFromRadius()))}function markerAt(e,n){return new google.maps.Marker({position:new google.maps.LatLng(e,n),map:gmap,icon:"/assets/icons/ublip_marker-3c0878cf26221b53d0b44c7d6eaf90e43fd149fcc420026d09842171470a36d7.png"})}function drawGeofence(){if(window.geofenceOverlay!=undefined&&window.geofenceOverlay.setMap(null),window.geofenceMarker!=undefined&&window.geofenceMarker.setMap(null),$("#geofence_shape_type_1").is(":checked")){if(0==polypoints_array.length)return!1;if(1==polypoints_array.length)window.geofenceMarker=markerAt(polypoints_array[0][0],polypoints_array[0][1]);else{var e=$("#geofence_color").val(),n=3;polygonal_drawing_open?(window.geofenceMarker=markerAt(polypoints_array[0][0],polypoints_array[0][1]),polypoints_array.length>2&&google.maps.event.addDomListener(window.geofenceMarker,"click",function(){closeShape()}),window.geofenceOverlay=new google.maps.Polyline({map:gmap,path:$.map(polypoints_array,function(e){return new google.maps.LatLng(e[0],e[1])}),strokeColor:e,strokeWeight:n,strokeOpacity:.8})):(polypoints_array[0][0]==polypoints_array[polypoints_array.length-1][0]&&polypoints_array[0][1]==polypoints_array[polypoints_array.length-1][1]||polypoints_array.push(polypoints_array[0]),window.geofenceOverlay=new google.maps.Polygon({map:gmap,path:$.map(polypoints_array,function(e){return new google.maps.LatLng(e[0],e[1])}),strokeColor:e,strokeWeight:n,strokeOpacity:.75,fillColor:e,fillOpacity:.1}),$("#geofence_area")&&$("#geofence_area").val(polygonArea(window.geofenceOverlay.getPath())))}}else{var e=$("#geofence_color").val(),o=1609.344*$("#geofence_radius").val(),n=3;window.centerMarker!=undefined&&window.centerMarker.setMap(null),window.centerMarker=new google.maps.Marker({position:new google.maps.LatLng(circle_center[0],circle_center[1]),map:gmap,icon:orangeSmallIcon}),window.geofenceOverlay=new google.maps.Circle({map:gmap,center:new google.maps.LatLng(circle_center[0],circle_center[1]),radius:o,strokeColor:e,strokeWeight:n,strokeOpactiy:.75,fillColor:e,fillOpacity:.1})}}function validate(){if(""==$("#geofence_name").val())return alert("Please specify a name for your geofence"),$("#geofence_name").focus(),!1;if($("#geofence_shape_type_1").is(":checked")){if(polygonal_drawing_open)return alert("Please close the currently open shape by clicking on the marker for the first coordinate"),!1;if(0==polypoints_array.length)return alert("Please draw a shape before saving this geofence."),!1}return""==$("#geofence_address").val()||"Street Address OR Latitude, Longitude"==$("#geofence_address").val()?(alert("You must enter an address or Latitude, Longitude."),!1):!window.geocode_button_needs_clicking&&(!address_modified||""!=$("#geofence_longitude").val()&&""!=$("#geofence_latitude").val())||(alert('Please click "Zoom Map to Address" and verify location before saving'),!1)}function switchTo(e){installFenceEditingListeners(),window.geofenceOverlay!=undefined&&window.geofenceOverlay.setMap(null),window.geofenceMarker!=undefined&&window.geofenceMarker.setMap(null),$("#geofence_polypoint_string").val(""),"circular"==e?($(".polygonal_fields").hide(),$(".circular_fields").show()):($(".polygonal_fields").show(),$(".circular_fields").hide())}var gmap,map,zoom=8,icon,geofences=[],currSelectedDeviceId,currSelectedGeofenceId,gf_index,address_modified=!1,circle_center=[],polygonal_drawing_open=!1,polypoints_array=[],orangeSmallIcon="/assets/icons/orange_small-86b81cdec0003be42699404532bc5fec45ef621e59b1da0708335f9a40f641c6.png";